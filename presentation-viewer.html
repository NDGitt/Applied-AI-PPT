<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Applied AI Presentation Editor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 300px;
            background: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 20px;
            background: #34495e;
            border-bottom: 1px solid #4a5f7a;
        }

        .sidebar-header h2 {
            margin-bottom: 10px;
            font-size: 18px;
        }

        .mode-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .mode-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .mode-btn.active {
            background: #3498db;
            color: white;
        }

        .mode-btn:not(.active) {
            background: #4a5f7a;
            color: #bdc3c7;
        }

        .mode-btn:hover:not(.active) {
            background: #5a6f8a;
        }

        /* Slide List */
        .slide-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .slide-item {
            background: #34495e;
            margin-bottom: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .slide-item:hover {
            background: #4a5f7a;
        }

        .slide-item.active {
            border-color: #3498db;
            background: #4a5f7a;
        }

        .slide-item.dragging {
            opacity: 0.5;
        }

        .slide-item-content {
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .slide-number {
            background: #3498db;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .slide-title {
            flex: 1;
            font-size: 14px;
            line-height: 1.3;
        }

        .slide-actions {
            display: flex;
            gap: 5px;
        }

        .action-btn {
            background: none;
            border: none;
            color: #bdc3c7;
            cursor: pointer;
            padding: 4px;
            border-radius: 3px;
            font-size: 12px;
        }

        .action-btn:hover {
            background: #5a6f8a;
            color: white;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .toolbar {
            background: #ecf0f1;
            padding: 15px 20px;
            border-bottom: 1px solid #bdc3c7;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toolbar-left {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .toolbar-right {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .slide-counter {
            font-size: 14px;
            color: #7f8c8d;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .slide-preview {
            flex: 1;
            border: none;
            background: white;
            position: relative;
        }

        .slide-preview.edit-mode {
            cursor: crosshair;
        }

        .slide-preview.edit-mode * {
            cursor: pointer;
        }

        .slide-preview.edit-mode *:hover {
            outline: 2px solid #3498db;
            outline-offset: 2px;
        }

        .slide-preview.edit-mode .editing {
            outline: 3px solid #e74c3c !important;
            outline-offset: 3px;
        }

        .editor-panel {
            width: 400px;
            background: #f8f9fa;
            border-left: 1px solid #dee2e6;
            display: none;
            flex-direction: column;
        }

        .editor-panel.active {
            display: flex;
        }

        .editor-header {
            padding: 15px;
            background: #e9ecef;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .editor-header h3 {
            font-size: 16px;
            color: #495057;
        }

        .close-editor {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #6c757d;
        }

        .editor-content {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }

        .editor-tabs {
            display: flex;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 15px;
        }

        .editor-tab {
            padding: 10px 15px;
            background: none;
            border: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: #6c757d;
        }

        .editor-tab.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
        }

        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        .html-editor {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }

        /* Quill Editor Styles */
        .quill-editor {
            height: 200px;
            margin-bottom: 15px;
        }

        .ql-editor {
            min-height: 150px;
        }

        /* Formatting Toolbar */
        .formatting-toolbar {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 15px;
        }

        .formatting-toolbar button {
            background: white;
            border: 1px solid #ced4da;
            padding: 5px 10px;
            margin-right: 5px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .formatting-toolbar button:hover {
            background: #e9ecef;
        }

        .formatting-toolbar button.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        /* Element Info */
        .element-info {
            background: #e9ecef;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 15px;
        }

        .element-info h4 {
            margin-bottom: 8px;
            color: #495057;
            font-size: 14px;
        }

        .element-info p {
            margin-bottom: 5px;
            font-size: 12px;
            color: #6c757d;
        }

        /* Loading States */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 16px;
            color: #7f8c8d;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .sidebar {
                width: 250px;
            }
            
            .editor-panel {
                width: 350px;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 200px;
            }
            
            .editor-panel {
                width: 100%;
                height: 300px;
            }
        }

        /* Drag and Drop Visual Feedback */
        .slide-item.sortable-ghost {
            opacity: 0.3;
        }

        .slide-item.sortable-chosen {
            background: #3498db;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: #27ae60;
        }

        .notification.error {
            background: #e74c3c;
        }

        .notification.info {
            background: #3498db;
        }

        /* Inline Editing Styles */
        .editable-element {
            position: relative;
        }

        .editable-element:hover::after {
            content: "Click to edit";
            position: absolute;
            top: -25px;
            left: 0;
            background: #3498db;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            z-index: 1000;
        }

        .editing-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(52, 152, 219, 0.1);
            pointer-events: none;
            z-index: 999;
        }

        /* Edit Mode Indicator */
        .edit-mode-indicator {
            background: #e74c3c;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>Applied AI Presentation</h2>
                <div class="mode-toggle">
                    <button class="mode-btn active" onclick="setMode('view')">View</button>
                    <button class="mode-btn" onclick="setMode('edit')">Edit</button>
                    <button class="mode-btn" onclick="setMode('arrange')">Arrange</button>
                </div>
            </div>
            
            <div class="slide-list" id="slideList">
                <!-- Slides will be populated here -->
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="toolbar">
                <div class="toolbar-left">
                    <button class="btn btn-primary" onclick="previousSlide()">‚Üê Previous</button>
                    <button class="btn btn-primary" onclick="nextSlide()">Next ‚Üí</button>
                    <span class="slide-counter" id="slideCounter">Slide 1 of 12</span>
                    <span class="edit-mode-indicator" id="editModeIndicator" style="display: none;">EDIT MODE</span>
                </div>
                
                <div class="toolbar-right">
                    <button class="btn btn-success" onclick="exportCombinedPDF()" id="exportBtn">Export Combined PDF</button>
                    <button class="btn btn-primary" onclick="saveChanges()" id="saveBtn">Save Changes</button>
                </div>
            </div>
            
            <div class="content-area">
                <iframe id="slideFrame" class="slide-preview" src="Page 1.html"></iframe>
                
                <div class="editor-panel" id="editorPanel">
                    <div class="editor-header">
                        <h3>Edit Element</h3>
                        <button class="close-editor" onclick="closeEditor()">√ó</button>
                    </div>
                    
                    <div class="editor-content">
                        <div class="editor-tabs">
                            <button class="editor-tab active" onclick="switchTab('visual')">Visual Editor</button>
                            <button class="editor-tab" onclick="switchTab('html')">HTML Code</button>
                        </div>
                        
                        <div class="tab-content active" id="visualTab">
                            <div class="element-info" id="elementInfo">
                                <h4>Element Information</h4>
                                <p>Click on any element in the slide to edit it</p>
                            </div>
                            
                            <div class="formatting-toolbar" id="formattingToolbar" style="display: none;">
                                <button onclick="formatText('bold')" title="Bold"><strong>B</strong></button>
                                <button onclick="formatText('italic')" title="Italic"><em>I</em></button>
                                <button onclick="formatText('underline')" title="Underline"><u>U</u></button>
                                <button onclick="formatText('color')" title="Text Color">üé®</button>
                                <button onclick="formatText('size')" title="Font Size">üìè</button>
                                <button onclick="formatText('align-left')" title="Align Left">‚¨ÖÔ∏è</button>
                                <button onclick="formatText('align-center')" title="Align Center">‚ÜîÔ∏è</button>
                                <button onclick="formatText('align-right')" title="Align Right">‚û°Ô∏è</button>
                            </div>
                            
                            <div class="form-group">
                                <label for="elementContent">Content</label>
                                <div id="quillEditor" class="quill-editor"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="elementStyle">Custom CSS</label>
                                <textarea id="elementStyle" class="form-control" placeholder="Add custom CSS styles..."></textarea>
                            </div>
                            
                            <button class="btn btn-primary" onclick="applyChanges()">Apply Changes</button>
                        </div>
                        
                        <div class="tab-content" id="htmlTab">
                            <div class="form-group">
                                <label for="htmlCode">HTML Code</label>
                                <textarea id="htmlCode" class="form-control html-editor" rows="20"></textarea>
                            </div>
                            
                            <button class="btn btn-primary" onclick="applyHtmlChanges()">Apply Changes</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
        // Global variables
        let slides = [];
        let currentSlideIndex = 0;
        let currentMode = 'view';
        let isEditing = false;
        let originalSlides = [];
        let currentEditingElement = null;
        let quillEditor = null;
        let slideFrame = null;

        // Initialize the application
        async function init() {
            await loadSlides();
            renderSlideList();
            updateSlide();
            setupEventListeners();
            setupSortable();
            initializeQuillEditor();
        }

        // Initialize Quill editor
        function initializeQuillEditor() {
            const quillContainer = document.getElementById('quillEditor');
            quillEditor = new Quill(quillContainer, {
                theme: 'snow',
                modules: {
                    toolbar: false // We'll use our custom toolbar
                },
                placeholder: 'Click on an element in the slide to edit its content...'
            });
        }

        // Load slides from the server
        async function loadSlides() {
            try {
                const response = await fetch('/api/slides');
                const data = await response.json();
                
                slides = data.slides.map((file, index) => ({
                    id: index + 1,
                    file: file,
                    title: getSlideTitle(file),
                    originalFile: file
                }));
                
                originalSlides = JSON.parse(JSON.stringify(slides));
            } catch (error) {
                console.error('Error loading slides:', error);
                showNotification('Error loading slides', 'error');
            }
        }

        // Get slide title from filename
        function getSlideTitle(filename) {
            const titles = {
                'Page 1.html': 'Applied AI for Startup Founders at Haas',
                'Page 2.html': 'Why Practical AI Entrepreneurship Now?',
                'Page 3.html': 'Course Overview',
                'Page 4.html': 'Learning Objectives',
                'Page 5.html': 'Course Structure',
                'Page 6.html': 'Module 1: AI Fundamentals',
                'Page 7.html': 'Module 2: AI Strategy',
                'Page 8.html': 'Module 3: AI Implementation',
                'Page 9.html': 'Module 4: AI Ethics',
                'Page 10.html': 'Assessment Methods',
                'Page 11.html': 'Resources & Support',
                'Page 12.html': 'Next Steps'
            };
            return titles[filename] || `Slide ${filename.replace('.html', '')}`;
        }

        // Render the slide list
        function renderSlideList() {
            const slideList = document.getElementById('slideList');
            slideList.innerHTML = '';
            
            slides.forEach((slide, index) => {
                const slideItem = document.createElement('div');
                slideItem.className = `slide-item ${index === currentSlideIndex ? 'active' : ''}`;
                slideItem.setAttribute('data-index', index);
                
                slideItem.innerHTML = `
                    <div class="slide-item-content">
                        <div class="slide-number">${index + 1}</div>
                        <div class="slide-title">${slide.title}</div>
                        <div class="slide-actions">
                            <button class="action-btn" onclick="duplicateSlide(${index})" title="Duplicate">üìã</button>
                            <button class="action-btn" onclick="deleteSlide(${index})" title="Delete">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
                
                slideItem.addEventListener('click', () => selectSlide(index));
                slideList.appendChild(slideItem);
            });
        }

        // Set application mode
        function setMode(mode) {
            currentMode = mode;
            
            // Update mode buttons
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update UI based on mode
            const slideList = document.getElementById('slideList');
            const editModeIndicator = document.getElementById('editModeIndicator');
            
            if (mode === 'arrange') {
                slideList.classList.add('sortable-enabled');
                editModeIndicator.style.display = 'none';
                disableEditMode();
            } else if (mode === 'edit') {
                slideList.classList.remove('sortable-enabled');
                editModeIndicator.style.display = 'inline-block';
                enableEditMode();
            } else {
                slideList.classList.remove('sortable-enabled');
                editModeIndicator.style.display = 'none';
                disableEditMode();
            }
        }

        // Enable edit mode
        function enableEditMode() {
            isEditing = true;
            const slideFrame = document.getElementById('slideFrame');
            slideFrame.classList.add('edit-mode');
            
            // Wait for iframe to load, then setup click handlers
            slideFrame.onload = function() {
                setupClickToEdit();
            };
            
            // If iframe is already loaded, setup immediately
            if (slideFrame.contentDocument && slideFrame.contentDocument.readyState === 'complete') {
                setupClickToEdit();
            }
        }

        // Disable edit mode
        function disableEditMode() {
            isEditing = false;
            const slideFrame = document.getElementById('slideFrame');
            slideFrame.classList.remove('edit-mode');
            closeEditor();
        }

        // Setup click-to-edit functionality
        function setupClickToEdit() {
            const slideFrame = document.getElementById('slideFrame');
            const iframeDoc = slideFrame.contentDocument || slideFrame.contentWindow.document;
            
            if (!iframeDoc) return;
            
            // Remove existing event listeners
            const allElements = iframeDoc.querySelectorAll('*');
            allElements.forEach(el => {
                el.removeEventListener('click', handleElementClick);
            });
            
            // Add click handlers to all elements
            allElements.forEach(el => {
                if (el.tagName !== 'HTML' && el.tagName !== 'BODY' && el.tagName !== 'HEAD') {
                    el.classList.add('editable-element');
                    el.addEventListener('click', handleElementClick);
                }
            });
        }

        // Handle element click
        function handleElementClick(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const element = event.target;
            currentEditingElement = element;
            
            // Remove previous editing class
            const iframeDoc = document.getElementById('slideFrame').contentDocument;
            if (iframeDoc) {
                iframeDoc.querySelectorAll('.editing').forEach(el => {
                    el.classList.remove('editing');
                });
            }
            
            // Add editing class to current element
            element.classList.add('editing');
            
            // Open editor and load element content
            openEditor();
            loadElementContent(element);
        }

        // Load element content into editor
        function loadElementContent(element) {
            const elementInfo = document.getElementById('elementInfo');
            const formattingToolbar = document.getElementById('formattingToolbar');
            
            // Update element info
            elementInfo.innerHTML = `
                <h4>Editing: ${element.tagName.toLowerCase()}</h4>
                <p>Tag: &lt;${element.tagName.toLowerCase()}&gt;</p>
                <p>Classes: ${element.className || 'none'}</p>
                <p>ID: ${element.id || 'none'}</p>
            `;
            
            // Show formatting toolbar
            formattingToolbar.style.display = 'block';
            
            // Load content into Quill editor
            if (quillEditor) {
                quillEditor.root.innerHTML = element.innerHTML;
            }
            
            // Load custom styles
            const computedStyle = window.getComputedStyle(element);
            const customStyles = [];
            
            // Extract relevant styles
            const styleProperties = ['color', 'font-size', 'font-weight', 'text-align', 'background-color'];
            styleProperties.forEach(prop => {
                const value = computedStyle.getPropertyValue(prop);
                if (value && value !== 'normal' && value !== '0px') {
                    customStyles.push(`${prop}: ${value};`);
                }
            });
            
            document.getElementById('elementStyle').value = customStyles.join('\n');
            
            // Load HTML code
            document.getElementById('htmlCode').value = element.outerHTML;
        }

        // Format text
        function formatText(format) {
            if (!quillEditor) return;
            
            switch (format) {
                case 'bold':
                    quillEditor.format('bold', !quillEditor.getFormat().bold);
                    break;
                case 'italic':
                    quillEditor.format('italic', !quillEditor.getFormat().italic);
                    break;
                case 'underline':
                    quillEditor.format('underline', !quillEditor.getFormat().underline);
                    break;
                case 'align-left':
                    quillEditor.format('align', 'left');
                    break;
                case 'align-center':
                    quillEditor.format('align', 'center');
                    break;
                case 'align-right':
                    quillEditor.format('align', 'right');
                    break;
                case 'color':
                    const color = prompt('Enter color (e.g., red, #ff0000):');
                    if (color) {
                        quillEditor.format('color', color);
                    }
                    break;
                case 'size':
                    const size = prompt('Enter font size (e.g., 16px, 1.2em):');
                    if (size) {
                        quillEditor.format('size', size);
                    }
                    break;
            }
        }

        // Apply changes to the element
        function applyChanges() {
            if (!currentEditingElement) return;
            
            const iframeDoc = document.getElementById('slideFrame').contentDocument;
            if (!iframeDoc) return;
            
            // Get content from Quill editor
            const newContent = quillEditor.root.innerHTML;
            
            // Get custom styles
            const customStyles = document.getElementById('elementStyle').value;
            
            // Apply content
            currentEditingElement.innerHTML = newContent;
            
            // Apply custom styles
            if (customStyles) {
                currentEditingElement.style.cssText += customStyles;
            }
            
            // Remove editing class
            currentEditingElement.classList.remove('editing');
            
            // Update HTML code
            document.getElementById('htmlCode').value = currentEditingElement.outerHTML;
            
            showNotification('Changes applied successfully', 'success');
        }

        // Setup sortable functionality
        function setupSortable() {
            const slideList = document.getElementById('slideList');
            
            new Sortable(slideList, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                onEnd: function(evt) {
                    const oldIndex = evt.oldIndex;
                    const newIndex = evt.newIndex;
                    
                    if (oldIndex !== newIndex) {
                        // Reorder slides array
                        const movedSlide = slides.splice(oldIndex, 1)[0];
                        slides.splice(newIndex, 0, movedSlide);
                        
                        // Update current slide index if needed
                        if (currentSlideIndex === oldIndex) {
                            currentSlideIndex = newIndex;
                        } else if (currentSlideIndex > oldIndex && currentSlideIndex <= newIndex) {
                            currentSlideIndex--;
                        } else if (currentSlideIndex < oldIndex && currentSlideIndex >= newIndex) {
                            currentSlideIndex++;
                        }
                        
                        renderSlideList();
                        updateSlide();
                        showNotification('Slides reordered successfully', 'success');
                    }
                }
            });
        }

        // Select a slide
        function selectSlide(index) {
            currentSlideIndex = index;
            renderSlideList();
            updateSlide();
        }

        // Update the current slide display
        function updateSlide() {
            if (slides.length === 0) return;
            
            const slide = slides[currentSlideIndex];
            const slideFrame = document.getElementById('slideFrame');
            const slideCounter = document.getElementById('slideCounter');
            
            slideFrame.src = slide.file;
            slideCounter.textContent = `Slide ${currentSlideIndex + 1} of ${slides.length}`;
            
            // Setup edit mode if needed
            if (isEditing) {
                slideFrame.onload = function() {
                    setupClickToEdit();
                };
            }
        }

        // Navigation functions
        function previousSlide() {
            if (currentSlideIndex > 0) {
                currentSlideIndex--;
                renderSlideList();
                updateSlide();
            }
        }

        function nextSlide() {
            if (currentSlideIndex < slides.length - 1) {
                currentSlideIndex++;
                renderSlideList();
                updateSlide();
            }
        }

        function openEditor() {
            const editorPanel = document.getElementById('editorPanel');
            editorPanel.classList.add('active');
        }

        function closeEditor() {
            const editorPanel = document.getElementById('editorPanel');
            editorPanel.classList.remove('active');
            
            // Remove editing class from current element
            if (currentEditingElement) {
                currentEditingElement.classList.remove('editing');
                currentEditingElement = null;
            }
            
            // Hide formatting toolbar
            document.getElementById('formattingToolbar').style.display = 'none';
        }

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.editor-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // Apply HTML changes
        function applyHtmlChanges() {
            if (!currentEditingElement) return;
            
            const htmlCode = document.getElementById('htmlCode').value;
            
            try {
                // Create a temporary div to parse the HTML
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlCode;
                const newElement = tempDiv.firstElementChild;
                
                if (newElement) {
                    // Replace the current element with the new one
                    currentEditingElement.parentNode.replaceChild(newElement, currentEditingElement);
                    currentEditingElement = newElement;
                    
                    // Re-setup click handlers
                    setupClickToEdit();
                    
                    showNotification('HTML changes applied', 'success');
                }
            } catch (error) {
                showNotification('Invalid HTML code', 'error');
            }
        }

        // Duplicate slide
        function duplicateSlide(index) {
            const originalSlide = slides[index];
            const newSlide = {
                ...originalSlide,
                id: slides.length + 1,
                title: originalSlide.title + ' (Copy)',
                file: `temp_${Date.now()}.html`
            };
            
            slides.splice(index + 1, 0, newSlide);
            renderSlideList();
            showNotification('Slide duplicated', 'success');
        }

        // Delete slide
        function deleteSlide(index) {
            if (slides.length <= 1) {
                showNotification('Cannot delete the last slide', 'error');
                return;
            }
            
            if (confirm('Are you sure you want to delete this slide?')) {
                slides.splice(index, 1);
                
                if (currentSlideIndex >= slides.length) {
                    currentSlideIndex = slides.length - 1;
                }
                
                renderSlideList();
                updateSlide();
                showNotification('Slide deleted', 'success');
            }
        }

        // Save changes
        async function saveChanges() {
            try {
                const response = await fetch('/api/save-slides', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ slides })
                });
                
                if (response.ok) {
                    showNotification('Changes saved successfully', 'success');
                    originalSlides = JSON.parse(JSON.stringify(slides));
                } else {
                    throw new Error('Failed to save changes');
                }
            } catch (error) {
                console.error('Error saving changes:', error);
                showNotification('Error saving changes', 'error');
            }
        }

        // Export combined PDF
        async function exportCombinedPDF() {
            const exportBtn = document.getElementById('exportBtn');
            const originalText = exportBtn.textContent;
            exportBtn.textContent = 'Generating PDF...';
            exportBtn.disabled = true;
            
            try {
                const response = await fetch('/api/export-combined', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ slides })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    
                    // Download the file
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'applied-ai-presentation.pdf';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showNotification('Combined PDF exported successfully', 'success');
                } else {
                    throw new Error('Failed to export PDF');
                }
            } catch (error) {
                console.error('Error exporting PDF:', error);
                showNotification('Error exporting PDF', 'error');
            } finally {
                exportBtn.textContent = originalText;
                exportBtn.disabled = false;
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Setup event listeners
        function setupEventListeners() {
            // Keyboard navigation
            document.addEventListener('keydown', function(e) {
                if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
                    previousSlide();
                } else if (e.key === 'ArrowRight' || e.key === 'ArrowDown' || e.key === ' ') {
                    nextSlide();
                } else if (e.key === 'Escape') {
                    closeEditor();
                }
            });
        }

        // Initialize the application
        init();
    </script>
</body>
</html> 